---
title: "Storm_time_series"
author: "Taryn Waite"
date: "6/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here, I'd like to create some individual time series objects out of storm events, so that I can experiment with decomposing them and plotting the trends on a concentration-discharge plot. I'll start by working through an example of one storm in the main channel site. The storm I'm using is the July 13 -- August 10, 2016 one because it's pretty long and has easy-to-see hysteresis loops associated with it.

The first step is to filter for the dates and select the appropriate columns. I'll use the file with hourly water quality and discharge.
```{r}
WQ_hourly_discharge <- read_csv("WQ_hourly_discharge.csv")

WQ_d_MC_1 <- WQ_hourly_discharge %>% 
  filter(date >= ymd("2016-07-13") & date <= ymd("2016-08-10")) %>% 
  filter(site == "MC") %>% 
  select(hourlyDischarge, NO3_mgL, FDOMqsu, BGAugL, CHLugL, Turb, dateTime)

# check for NAs
sum(is.na(WQ_d_MC_1))
```

There are no NA values in this subset (yay!) so it's ready to become a time series object.

```{r}
# ts object for chlorophyll
storm_1_ts_chl <- ts(WQ_d_MC_1$CHLugL, start = 0, frequency = 12)
plot(storm_1_ts_chl)
# decomposition for chlorophyll
fit_1_chl <- stl(storm_1_ts_chl, s.window="periodic")
plot(fit_1_chl)

# ts object for turbidity
storm_1_ts_turb <- ts(WQ_d_MC_1$Turb, start = 0, frequency = 12)
plot(storm_1_ts_turb)
# decomposition for turbidity
fit_1_turb <- stl(storm_1_ts_turb, s.window="periodic")
plot(fit_1_turb)
```

Now, I'll try plotting a concentration-discharge relationship but using the trend instead of the raw data. 

```{r}
# need a df with the original discharge and the trend concentration
temp <- cbind.data.frame(WQ_d_MC_1$dateTime, WQ_d_MC_1$hourlyDischarge, fit_1_chl$time.series[,2])
names(temp) <- c("dateTime", "discharge", "trendCHL")
# smoothed c-q plot
smooth <- temp %>% ggplot(aes(x = discharge, y = trendCHL)) +
  geom_path()
# original c-q plot
original <- WQ_d_MC_1 %>% ggplot(aes(x = hourlyDischarge, y = CHLugL)) +
  geom_path()

# need a df with the original discharge and the trend concentration
temp2 <- cbind.data.frame(WQ_d_MC_1$dateTime, WQ_d_MC_1$hourlyDischarge, fit_1_turb$time.series[,2])
names(temp2) <- c("dateTime", "discharge", "trendTurb")
# smoothed c-q plot
smooth2 <- temp2 %>% ggplot(aes(x = discharge, y = trendTurb)) +
  geom_path()
# original c-q plot
original2 <- WQ_d_MC_1 %>% ggplot(aes(x = hourlyDischarge, y = Turb)) +
  geom_path()

ggarrange(original, smooth, original2, smooth2)
 

```

