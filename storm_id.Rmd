---
title: "Identifying Storm Events"
author: "Taryn Waite"
date: "6/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggpubr)
library(EcoHydRology)
```


Below, I tried identifying each day as a "storm" day or a "baseline" day depending on the change in discharge between the day and the next day. A day is considered "storm" if the discharge increases by more than 10% in the day. However, I don't think this worked well, judging by the plot I created at the end. It mostly just catches the very beginning of what seem to be storm events.

```{r}

## tried with dplyr but I couldn't get it to work
dates <- discharge[[3]]

get_discharge <- function(date){
  if(date %in% dates){
    day_data <- discharge %>% 
      filter(Date == date)
    return((day_data[[4]]))
  }
  else{
    print("next day NA")
    return(NA)
  }
}


get_change_discharge <- function(date){
  return(get_discharge(date + 1 ) - get_discharge(date)) 
}

## this is where it wouldn't work 
#discharge %>%
  #mutate(change = get_change_discharge(Date))


## instead, I just found the difference by arranging by date and
## subtracting each from the previous (this works because no days are skipped)

# arrange by date
temp <- discharge %>% 
  rename(daily_discharge = X_00060_00003) %>% 
  arrange(Date) 

# calculate difference column
temp$diff <- lead(temp$daily_discharge, 1) - temp$daily_discharge

# give storm or baseline status depending on magnitude of change
storm1 <- temp %>% 
  mutate(status = case_when(abs(diff) > daily_discharge/10 ~ "storm", abs(diff) <= daily_discharge/10 ~"base"))
         

# plot for 2017
storm1 %>% 
  filter(year(Date) == 2017) %>% 
  ggplot(aes(x = Date, y = daily_discharge)) +
  geom_line() +
  geom_point(aes(x = Date, y = daily_discharge, col = status)) 


```

Maybe, since this technique seems to capture the beginning of storm events, we could flag when the discharge *increases* by at least 10% and then also flag all the days after until the discharge returns to the level it was on the initial flagged day

```{r}
# new version of storm dataframe which flags just positive increases in discharge by over 10%
# to capture the start of a storm
storm2 <- temp %>% 
  mutate(status = case_when(diff > daily_discharge/10 ~ "storm", diff <= daily_discharge/10 ~"base"))

# plot for 2016
storm2 %>% 
  filter(year(Date) == 2017) %>% 
  filter(month(Date) %in% c(6, 7, 8, 9)) %>% 
  ggplot(aes(x = Date, y = daily_discharge)) +
  geom_line() +
  geom_point(aes(x = Date, y = daily_discharge, col = status))  


```

## Baseflow separation with EcoHydRology package

The EcoHydRology package has a function called BaseflowSeparation(), which uses a low-pass filter technique to estimate how much of the discharge each day is attributed to base flow and how much came from runoff (i.e. from precipitation). This is useful because it could help us to identify storm events -- a high proportion of discharge attributed to runoff indicates a lot of precipitation (potentially a storm event).

```{r baseflow separation}
## create a dataframe with the baseflow and the quickflow for each day
baseflowSep <- BaseflowSeparation(discharge$X_00060_00003, filter_parameter = 0.925, passes = 3)

## need a df with just date and discharge for the hydrograph function
discharge2 <- discharge[,c(3,4)]
## plot the discharge (black line) and baseflow (red dotted line) over time
hydrograph(input=discharge2,streamflow2=baseflowSep[,1])
```

```{r}
baseflowSep %>% 
  filter(qft < bt/100)
```

## Concentration-discharge relationships

Below, I've defined a function that takes in a start date, end date, and variable name (all as strings) and creates a plot of discharge between the dates, a plot of the variable value between the dates, and a concentration-discharge plot between the dates (all for both sites). For the concentration-discharge plot, I used geom_path() so that the points in discharge-concentration space would be connected in time order. 

```{r storm event plotting function}
# given a start date, end date and a variable, creates 3 plots:
# plot of the discharge between the dates for both sites,
# plot of the variable between the dates for both sites,
# concentration-discharge plot between the dates for both sites
storm_plots <- function(startDate, endDate, var) {
  par(mfrow=c(3,1))
  
  # plot of discharge over time
  a <- WQ_discharge %>% 
    filter(date >= ymd(startDate) & date <= ymd(endDate)) %>% 
    ggplot(aes(x = date, y = discharge, col = "site")) +
    geom_line() 
 
  # plot of the variable over time
  b <-  WQ_discharge %>% 
    filter(date >= ymd(startDate) & date <= ymd(endDate)) %>% 
    ggplot(aes_string(x = "date", y = var, col = "site")) +
    geom_line() 
  
  # concentration-discharge plot
  c <-  WQ_discharge %>% 
    filter(date >= ymd(startDate) & date <= ymd(endDate)) %>% 
    ggplot(aes_string(x = "discharge", y = var, col = "site")) +
    geom_path() 
 
  # put all 3 plots together
  figure <- ggarrange(a, b, c)
  return(figure)
}

```

Here are examples of the plots produced by the storm_plots function for some storm events that I've identified visually. These seem to take a really long time to run and I'm not sure why.
```{r storm plotting examples}

storm_plots("2016-07-13", "2016-08-10", "CHLugL")
storm_plots("2016-07-13", "2016-08-10", "NO3_mgL")

storm_plots("2017-07-19", "2017-07-25", "CHLugL")
storm_plots("2017-07-19", "2017-07-25", "NO3_mgL")

storm_plots("2015-07-06", "2015-07-28", "CHLugL")
storm_plots("2015-07-06", "2015-07-28", "NO3_mgL")

storm_plots("2018-06-15", "2018-07-31", "CHLugL")
storm_plots("2018-06-15", "2018-07-31", "NO3_mgL")

```






